- name: install nginx
  apt: pkg=nginx state=installed

- name: configure letsencrypt config
  template: src=config/letsencrypt.conf dest=/etc/nginx/snippets/letsencrypt.conf

- name: configure nginx sites as available
  template: src={{item}} dest=/etc/nginx/sites-available/{{ item | basename }}
  with_fileglob:
   - templates/vhosts/*
  notify:
   - restart nginx

- name: Configure nginx sites as enabled
  file: path=/etc/nginx/sites-enabled/{{ item | basename }} src=../sites-available/{{ item | basename }} state=link
  with_fileglob:
   - templates/vhosts/*
  notify:
   - restart nginx

- name: Configure dead nginx sites as disabled
  file: path=/etc/nginx/sites-enabled/{{ item | basename }} state=absent
  with_fileglob:
   - templates/deleted_vhosts/*
  notify:
   - restart nginx

- name: Configure dead nginx sites as unavailable
  file: path=/etc/nginx/sites-available/{{ item | basename }} state=absent
  with_fileglob:
   - templates/deleted_vhosts/*
  notify:
   - restart nginx

- name: Configure nginx redirects
  template: src=config/redirects.nginx.j2 dest=/etc/nginx/conf.d/www_redirects.conf
  vars:
    add_www:
    - aquarionics.com
    - cleartextcontent.co.uk
    remove_www:
    - omnyom.com
    - factionfiction.net
    - warehousebasement.com
  notify:
   - restart nginx

- name: Fix diffie-hellman insecurites
  include: diffie-hellman.yml
