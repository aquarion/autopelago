
- name: Install Exim
  apt:
    pkg: exim4
    state: present

- name: Add exim to certbot access users
  user: name={{ item }} groups=certbot_access append=yes
  with_items:
   - Debian-exim
  tags:
    - exim

- name: Install update-exim.conf config
  template:
    src: update-exim4.conf.conf.j2
    dest: /etc/exim4//update-exim4.conf.conf
    owner: root
    group: root
    mode: 0640
    # validate: "update-exim4.conf --check %s"
  tags:
    - exim

- name: Install exim config
  template:
    src: exim.conf.j2
    dest: /etc/exim4/conf.d/main/00_water_gkhs_custom
    owner: root
    group: root
    mode: 0640
    # validate: "update-exim4.conf --check %s"
  vars:
    cert_id: "{{ letsencrypt_dir }}"
  tags:
    - exim

- name: Set mailname
  copy:
    dest: /etc/mailname
    content: "{{ hostname }}"
  tags:
    - exim

- name: Check Exim Config before state
  stat: path=/var/lib/exim4/config.autogenerated get_checksum=yes
  register: exim_before
  tags:
    - exim

- name: reconfigure exim
  shell: update-exim4.conf
  changed_when: False # Not great, but stops this being a change every run
  tags:
    - exim


- name: Check Exim Config after state
  stat: path=/var/lib/exim4/config.autogenerated get_checksum=yes
  register: exim_after
  tags:
    - exim


- name: Restart Exim
  when: exim_before.stat.checksum != exim_after.stat.checksum
  service: name=exim4 state=restarted
  tags:
    - exim
