---
- name: Test firth-sftp-docker role
  hosts: localhost
  remote_user: root
  vars:
    sftp_users:
      - name: testuser1
        home: /srv/sftp/testuser1
        subdir: uploads
        ssh_key: "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQC7vbqajDhA... testuser1@example.com"
      - name: testuser2
        home: /srv/sftp/testuser2
        subdir: files
        ssh_key: "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQD8xyz123... testuser2@example.com"
  roles:
    - firth-sftp-docker

  post_tasks:
    - name: Test - Check if SSH service is running
      ansible.builtin.systemd:
        name: ssh
      register: ssh_service_status
      failed_when: ssh_service_status.status.ActiveState != "active"

    - name: Test - Verify SFTP group exists
      ansible.builtin.getent:
        database: group
        key: sftpusers
      register: sftp_group_check

    - name: Test - Verify SFTP users exist
      ansible.builtin.getent:
        database: passwd
        key: "{{ item.name }}"
      register: sftp_user_check
      loop: "{{ sftp_users }}"
      failed_when: sftp_user_check.msg is defined

    - name: Test - Check user shells are set to nologin
      ansible.builtin.shell: "set -o pipefail && getent passwd {{ item.name }} | cut -d: -f7"
      register: user_shell
      loop: "{{ sftp_users }}"
      failed_when: user_shell.stdout != "/usr/sbin/nologin"
      changed_when: false

    - name: Test - Verify chroot directories exist with correct permissions
      ansible.builtin.stat:
        path: "{{ item.home }}"
      register: chroot_dir_stat
      loop: "{{ sftp_users }}"
      failed_when:
        - not chroot_dir_stat.stat.exists
        - chroot_dir_stat.stat.pw_name != "root"
        - chroot_dir_stat.stat.gr_name != "root"
        - chroot_dir_stat.stat.mode != "0755"

    - name: Test - Verify user subdirectories exist with correct ownership
      ansible.builtin.stat:
        path: "{{ item.home }}/{{ item.subdir | default('files') }}"
      register: subdir_stat
      loop: "{{ sftp_users }}"
      failed_when:
        - not subdir_stat.stat.exists
        - subdir_stat.stat.pw_name != item.name
        - subdir_stat.stat.gr_name != "sftpusers"

    - name: Test - Check SSH authorized_keys files exist
      ansible.builtin.stat:
        path: "{{ item.home }}/.ssh/authorized_keys"
      register: auth_keys_stat
      loop: "{{ sftp_users }}"
      failed_when:
        - not auth_keys_stat.stat.exists
        - auth_keys_stat.stat.pw_name != item.name
        - auth_keys_stat.stat.mode != "0600"

    - name: Test - Validate SSH configuration syntax
      ansible.builtin.command: /usr/sbin/sshd -t
      changed_when: false

    - name: Test - Check SSH config contains SFTP subsystem
      ansible.builtin.lineinfile:
        path: /etc/ssh/sshd_config
        line: "Subsystem sftp internal-sftp"
        state: absent
      check_mode: true
      register: sftp_subsystem_check
      failed_when: not sftp_subsystem_check.changed

    - name: Test - Check SSH config contains Match Group for sftpusers
      ansible.builtin.lineinfile:
        path: /etc/ssh/sshd_config
        line: "Match Group sftpusers"
        state: absent
      check_mode: true
      register: match_group_check
      failed_when: not match_group_check.changed

    - name: Test - Verify users cannot login with shell
      ansible.builtin.shell: "set -o pipefail && su - {{ item.name }} -c 'whoami'"
      register: shell_login_test
      loop: "{{ sftp_users }}"
      failed_when: shell_login_test.rc == 0
      changed_when: false
      ignore_errors: true

    - name: Test - Display test results
      ansible.builtin.debug:
        msg: "All SFTP server tests passed successfully!"
