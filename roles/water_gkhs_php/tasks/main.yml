- name: Remove old PHP PPA
  ansible.builtin.apt_repository:
    repo: ppa:ondrej/php
    state: absent
  notify:
    - Apt Cache Update
  tags:
    - php
    - package_sources

- name: Get Launchpad PPA Info
  ansible.builtin.uri:
    url: "https://api.launchpad.net/devel/~ondrej/+archive/ubuntu/php"
    return_content: true
    method: GET
    headers:
      Accept: "application/json"
  register: firth_packages_ondrej_php_ppa_info
  notify:
    - Apt Cache Update
  tags:
    - php
    - package_sources

- name: Manage PHP PPA repository (deb822_repository)
  become: true
  ansible.builtin.deb822_repository:
    state: present
    name: "ondrej-ubuntu-php-{{ ansible_distribution_release }}"
    types: [deb]
    uris: [https://ppa.launchpadcontent.net/ondrej/php/ubuntu]
    suites: ["{{ ansible_facts['distribution_release'] }}"]
    components: [main]
    signed_by: "https://keyserver.ubuntu.com/pks/lookup?op=get&search=0x{{  firth_packages_ondrej_php_ppa_info.json.signing_key_fingerprint }}"
  tags: php

- name: Remove old PHP Packages
  ansible.builtin.apt:
    state: absent
    pkg:
      - "{{ item }}"
      - "{{ item }}-*"
  loop: "{{ remove_php_packages }}"
  exclude: "{{ php_package }}"
  ignore_errors: true
  tags: php

- name: Install PHP With Required Extensions
  ansible.builtin.apt:
    state: present
    pkg:
      - "{{ php_package }}"
      - "{{ php_package }}-bcmath"
      - "{{ php_package }}-cgi"
      - "{{ php_package }}-cli"
      - "{{ php_package }}-common"
      - "{{ php_package }}-curl"
      - "{{ php_package }}-gd"
      - "{{ php_package }}-intl"
      - "{{ php_package }}-mbstring"
      - "{{ php_package }}-mysql"
      - "{{ php_package }}-opcache"
      - "{{ php_package }}-readline"
      - "{{ php_package }}-xml"
      - "{{ php_package }}-zip"
  tags: php
